#!/usr/bin/env bash

DIM=$'\e[2m'
GREEN=$'\e[32m'
BLUE=$'\e[34m'
CYAN=$'\e[36m'
RESET=$'\e[0m'

ARCH_RSS_FEED="https://archlinux.org/feeds/news/"
ARCH_NEWS_URL="https://archlinux.org/news/"

echo

# Print clickable header
printf '\e]8;;%s\a%s\e]8;;\a\n' \
  "$ARCH_NEWS_URL" \
  "${GREEN}Arch Linux News:${RESET} ${DIM}(click a title to open the article)${RESET}"

# Fetch and print latest news with pubDate formatted as dd.mm.yyyy
curl -s "$ARCH_RSS_FEED" |
  xmlstarlet sel -T -t \
    -m "//item" \
    -v "normalize-space(pubDate)" -o "|" \
    -v "normalize-space(title)" -o "|" \
    -v "normalize-space(link)" -n |
  while IFS="|" read -r pubdate title link; do
    # Parse RFC822-ish date and format as dd.mm.yyyy (Arch feed uses "+0000")
    date_fmt="$(LC_ALL=C date -d "$pubdate" +'%d.%m.%Y' 2>/dev/null || echo '??.??.????')"

    printf ' - %s \e]8;;%s\a%s\e]8;;\a\n' "${CYAN}${date_fmt}${RESET}" "$link" "$title"
  done

exec "$(dirname "$(dirname "$(realpath "$0")")")/run.sh" -q
